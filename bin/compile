#!/usr/bin/env bash

set -eo pipefail

OAUTH2_PROXY_VERSION="v6.0.1-debug"
OAUTH2_PROXY_CHECKSUM="8a11d81989edcdc1f76b424b4ef2ec501001deb86523e72a266e4c45ec6d7a1c"

BP_DIR="$(cd $(dirname "$0"); pwd)"
BUILD_DIR="$1"

mkdir -p "$BUILD_DIR/bin"

echo "downloading oauth2-proxy..."
URL="https://a648d014f9e9.ngrok.io/oauth2-proxy-v6.0.0-11-g215aeec-dirty.linux-amd64.go1.14.4.tar.gz" 
wget --no-verbose $URL
mv oauth2-proxy-*.tar.gz oauth2-proxy.tar.gz
# echo "$OAUTH2_PROXY_CHECKSUM  oauth2-proxy.tar.gz" | sha256sum -c -
tar -xzf oauth2-proxy.tar.gz -C "$BUILD_DIR/bin" --strip-components=1
rm oauth2-proxy.tar.gz

# write out a start script
cp "${BP_DIR}"/../scripts/start_*.sh "${BUILD_DIR}/bin"
